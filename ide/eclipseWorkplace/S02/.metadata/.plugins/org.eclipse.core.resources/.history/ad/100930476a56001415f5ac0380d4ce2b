


import com.qihoo.gamecenter.sdk.common.IDispatcherCallback;
import com.qihoo.gamecenter.sdk.protocols.pay.ProtocolConfigs;
import com.qihoo.gamecenter.sdk.protocols.pay.ProtocolKeys;
import com.qihoopay.insdk.activity.ContainerActivity;
import com.qihoopay.insdk.matrix.Matrix;
import com.test.sdk.R;
import com.test.sdk.common.QihooPayInfo;
import com.test.sdk.common.SdkAccountListener;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.app.Activity;
import android.app.ActivityManager;
import android.app.ActivityManager.RunningTaskInfo;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.os.Environment;
import android.os.Handler;
import android.text.TextUtils;
import android.util.Log;
import android.widget.Toast;

import java.util.List;

/**
 * SdkUserBaseActivityè¿™ä¸ªåŸºç±»ï¼Œå¤„ç†è¯·æ±?360SDKçš„ç™»å½•å’Œæ”¯ä»˜æ¥å£ã€?
 * ä½¿ç”¨æ–¹çš„Activityç»§æ‰¿SdkUserBaseActivityï¼Œè°ƒç”¨doSdkLoginæ¥å£å‘èµ·ç™»å½•è¯·æ±‚ï¼›è°ƒç”¨doSdkPayæ¥å£å‘èµ·æ”¯ä»˜è¯·æ±‚ã€?
 * çˆ¶ç±»é€šè¿‡onGotAuthorizationCodeé€šçŸ¥å­ç±»ç™»å½•è·å–çš„æˆæƒç 
 * ï¼Œå­ç±»å®ç°onGotAuthorizationCodeæ¥å£æ¥æ”¶æˆæƒç ï¼Œåšåç»­å¤„ç†ã??
 */
public abstract class SdkUserBaseActivity extends Activity implements SdkAccountListener {

    private static final String TAG = "SdkUserBaseActivity";

    // ---------------------------------è°ƒç”¨360SDKæ¥å£------------------------------------

    /**
     * ä½¿ç”¨360SDKçš„ç™»å½•æ¥å?
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±æ˜¾ç¤ºç™»å½•ç•Œé¢
     * @param isBgTransparent æ˜¯å¦ä»¥é?æ˜èƒŒæ™¯æ˜¾ç¤ºç™»å½•ç•Œé¢
     */
    protected void doSdkLogin(boolean isLandScape, boolean isBgTransparent) {

        Intent intent = getLoginIntent(isLandScape, isBgTransparent);

        Matrix.invokeActivity(this, intent, mLoginCallback);
    }

    /**
     * ä½¿ç”¨360SDKçš„åˆ‡æ¢è´¦å·æ¥å?
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±æ˜¾ç¤ºç™»å½•ç•Œé¢
     * @param isBgTransparent æ˜¯å¦ä»¥é?æ˜èƒŒæ™¯æ˜¾ç¤ºç™»å½•ç•Œé¢
     */
    protected void doSdkSwitchAccount(boolean isLandScape, boolean isBgTransparent) {

        Intent intent = getSwitchAccountIntent(isLandScape, isBgTransparent);

        Matrix.invokeActivity(this, intent, mAccountSwitchCallback);
    }

    /**
     * ä½¿ç”¨360SDKçš„æ”¯ä»˜æ¥å?
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
     * @param isFixed æ˜¯å¦å®šé¢æ”¯ä»˜
     */
    protected void doSdkPay(final boolean isLandScape, final boolean isFixed,
            final boolean isBgTransparent) {

        // æ”¯ä»˜åŸºç¡€å‚æ•°
        Intent intent = getPayIntent(isLandScape, isFixed);

        // å¿…éœ€å‚æ•°ï¼Œä½¿ç”?360SDKçš„æ”¯ä»˜æ¨¡å—ã??
        intent.putExtra(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_PAY);

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç™»å½•ç•Œé¢èƒŒæ™¯æ˜¯å¦é€æ˜ã€?
        intent.putExtra(ProtocolKeys.IS_LOGIN_BG_TRANSPARENT, isBgTransparent);

        Matrix.invokeActivity(this, intent, mPayCallback);
    }

    /**
     * ä½¿ç”¨360SDKçš„é??å‡ºæ¥å?
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
     */
    protected void doSdkQuit(boolean isLandScape) {

        Intent intent = getQuitIntent(isLandScape);

        Matrix.invokeActivity(this, intent, mQuitCallback);
    }

    /**
     * ä½¿ç”¨360SDKçš„è®ºå›æ¥å?
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
     */
    protected void doSdkBBS(boolean isLandScape) {

        Intent intent = getBBSIntent(isLandScape);

        Matrix.invokeActivity(this, intent, null);
    }

    /**
     * ä½¿ç”¨360SDKå®¢æœä¸­å¿ƒæ¥å£
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±æ˜¾ç¤ºç•Œé¢
     */
    protected void doSdkCustomerService(boolean isLandScape) {

        Intent intent = getCustomerServiceIntent(isLandScape);

        Matrix.invokeActivity(this, intent, null);
    }

    /**
     * ä½¿ç”¨360SDKå®åæ³¨å†Œæ¥å£
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±æ˜¾ç¤ºç™»å½•ç•Œé¢
     * @param isBgTransparent æ˜¯å¦ä»¥é?æ˜èƒŒæ™¯æ˜¾ç¤ºç™»å½•ç•Œé¢
     */
    protected void doSdkRealNameRegister(boolean isLandScape, boolean isBgTransparent,
            String qihooUserId) {

        Intent intent = getRealNameRegisterIntent(isLandScape, isBgTransparent, qihooUserId);

        Matrix.invokeActivity(this, intent, mRealNameRegisterCallback);
    }

    /**
     * ä½¿ç”¨360SDKç»‘å®šæ‰‹æœºå·æ¥å?
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±æ˜¾ç¤ºç™»å½•ç•Œé¢
     * @param isBgTransparent æ˜¯å¦ä»¥é?æ˜èƒŒæ™¯æ˜¾ç¤ºç™»å½•ç•Œé¢
     */
    protected void doSdkBindPhoneNum(boolean isLandScape) {

        Intent intent = getBindPhoneNumIntent(isLandScape);

        Matrix.invokeActivity(this, intent, mBindPhoneNumCallback);
    }

    /**
     * ä½¿ç”¨360SDKæˆªå±å‘å¸–æ¥å£
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±æ˜¾ç¤ºç•Œé¢
     */
    protected void doSdkBBSPost(boolean isLandScape) {

        Intent intent = getBBSPostIntent(isLandScape);

        Matrix.invokeActivity(this, intent, null);
    }



    // -----------------------------------å‚æ•°Intent-------------------------------------

    /***
     * ç”Ÿæˆè°ƒç”¨360SDKç™»å½•æ¥å£çš„Intent
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±
     * @param isBgTransparent æ˜¯å¦èƒŒæ™¯é€æ˜
     * @param appKey åº”ç”¨æˆ–æ¸¸æˆçš„AppKey
     * @param appChannel åº”ç”¨æˆ–æ¸¸æˆçš„è‡ªå®šä¹‰å­æ¸ é“
     * @return Intent
     */
    private Intent getLoginIntent(boolean isLandScape, boolean isBgTransparent) {

        Bundle bundle = new Bundle();

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç•Œé¢æ˜¯å¦ä»¥æ¨ªå±æ˜¾ç¤ºã??
        bundle.putBoolean(ProtocolKeys.IS_SCREEN_ORIENTATION_LANDSCAPE, isLandScape);

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç™»å½•ç•Œé¢èƒŒæ™¯æ˜¯å¦é€æ˜ã€?
        bundle.putBoolean(ProtocolKeys.IS_LOGIN_BG_TRANSPARENT, isBgTransparent);

        // *** ä»¥ä¸‹éç•Œé¢ç›¸å…³å‚æ•? ***

        // å¿…éœ€å‚æ•°ï¼Œä½¿ç”?360SDKçš„ç™»å½•æ¨¡å—ã??
        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_LOGIN);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }

    /***
     * ç”Ÿæˆè°ƒç”¨360SDKåˆ‡æ¢è´¦å·æ¥å£çš„Intent
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±
     * @param isBgTransparent æ˜¯å¦èƒŒæ™¯é€æ˜
     * @return Intent
     */
    private Intent getSwitchAccountIntent(boolean isLandScape, boolean isBgTransparent) {

        Bundle bundle = new Bundle();

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç•Œé¢æ˜¯å¦ä»¥æ¨ªå±æ˜¾ç¤ºã??
        bundle.putBoolean(ProtocolKeys.IS_SCREEN_ORIENTATION_LANDSCAPE, isLandScape);

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç™»å½•ç•Œé¢èƒŒæ™¯æ˜¯å¦é€æ˜ã€?
        bundle.putBoolean(ProtocolKeys.IS_LOGIN_BG_TRANSPARENT, isBgTransparent);

        // *** ä»¥ä¸‹éç•Œé¢ç›¸å…³å‚æ•? ***

        // å¿…éœ€å‚æ•°ï¼Œä½¿ç”?360SDKçš„åˆ‡æ¢è´¦å·æ¨¡å—ã??
        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_SWITCH_ACCOUNT);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }

    /***
     * ç”Ÿæˆè°ƒç”¨360SDKæ”¯ä»˜æ¥å£åŸºç¡€å‚æ•°çš„Intent
     *
     * @param isLandScape
     * @param pay
     * @return Intent
     */
    protected Intent getPayIntent(boolean isLandScape, boolean isFixed) {

        Bundle bundle = new Bundle();

        QihooPayInfo pay = getQihooPayInfo(isFixed);

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç•Œé¢æ˜¯å¦ä»¥æ¨ªå±æ˜¾ç¤ºã??
        bundle.putBoolean(ProtocolKeys.IS_SCREEN_ORIENTATION_LANDSCAPE, isLandScape);

        // *** ä»¥ä¸‹éç•Œé¢ç›¸å…³å‚æ•? ***

        // è®¾ç½®QihooPayä¸­çš„å‚æ•°ã€?
        // å¿…éœ€å‚æ•°ï¼Œç”¨æˆ·access tokenï¼Œè¦ä½¿ç”¨æ³¨æ„è¿‡æœŸå’Œåˆ·æ–°é—®é¢˜ï¼Œæœ?å¤?64å­—ç¬¦ã€?
        bundle.putString(ProtocolKeys.ACCESS_TOKEN, pay.getAccessToken());

        // å¿…éœ€å‚æ•°ï¼?360è´¦å·idï¼Œæ•´æ•°ã??
        bundle.putString(ProtocolKeys.QIHOO_USER_ID, pay.getQihooUserId());

        // å¿…éœ€å‚æ•°ï¼Œæ‰€è´­ä¹°å•†å“é‡‘é¢, ä»¥åˆ†ä¸ºå•ä½ã?‚é‡‘é¢å¤§äºç­‰äº?100åˆ†ï¼Œ360SDKè¿è¡Œå®šé¢æ”¯ä»˜æµç¨‹ï¼? é‡‘é¢æ•°ä¸º0ï¼?360SDKè¿è¡Œä¸å®šé¢æ”¯ä»˜æµç¨‹ã??
        bundle.putString(ProtocolKeys.AMOUNT, pay.getMoneyAmount());

        // å¿…éœ€å‚æ•°ï¼Œäººæ°‘å¸ä¸æ¸¸æˆå……å€¼å¸çš„é»˜è®¤æ¯”ä¾‹ï¼Œä¾‹å¦‚2ï¼Œä»£è¡?1å…ƒäººæ°‘å¸å¯ä»¥å…‘æ¢2ä¸ªæ¸¸æˆå¸ï¼Œæ•´æ•°ã??
        bundle.putString(ProtocolKeys.RATE, pay.getExchangeRate());

        // å¿…éœ€å‚æ•°ï¼Œæ‰€è´­ä¹°å•†å“åç§°ï¼Œåº”ç”¨æŒ‡å®šï¼Œå»ºè®®ä¸­æ–‡ï¼Œæœ€å¤?10ä¸ªä¸­æ–‡å­—ã€?
        bundle.putString(ProtocolKeys.PRODUCT_NAME, pay.getProductName());

        // å¿…éœ€å‚æ•°ï¼Œè´­ä¹°å•†å“çš„å•†å“idï¼Œåº”ç”¨æŒ‡å®šï¼Œæœ?å¤?16å­—ç¬¦ã€?
        bundle.putString(ProtocolKeys.PRODUCT_ID, pay.getProductId());

        // å¿…éœ€å‚æ•°ï¼Œåº”ç”¨æ–¹æä¾›çš„æ”¯ä»˜ç»“æœé?šçŸ¥uriï¼Œæœ€å¤?255å­—ç¬¦ã€?360æœåŠ¡å™¨å°†æŠŠæ”¯ä»˜æ¥å£å›è°ƒç»™è¯¥uriï¼Œå…·ä½“åè®®è¯·æŸ¥çœ‹æ–‡æ¡£ä¸­ï¼Œæ”¯ä»˜ç»“æœé€šçŸ¥æ¥å£â€“åº”ç”¨æœåŠ¡å™¨æä¾›æ¥å£ã€?
        bundle.putString(ProtocolKeys.NOTIFY_URI, pay.getNotifyUri());

        // å¿…éœ€å‚æ•°ï¼Œæ¸¸æˆæˆ–åº”ç”¨åç§°ï¼Œæœ€å¤?16ä¸­æ–‡å­—ã??
        bundle.putString(ProtocolKeys.APP_NAME, pay.getAppName());

        // å¿…éœ€å‚æ•°ï¼Œåº”ç”¨å†…çš„ç”¨æˆ·åï¼Œå¦‚æ¸¸æˆè§’è‰²åã?? è‹¥åº”ç”¨å†…ç»‘å®š360è´¦å·å’Œåº”ç”¨è´¦å·ï¼Œåˆ™å¯ç”?360ç”¨æˆ·åï¼Œæœ?å¤?16ä¸­æ–‡å­—ã?‚ï¼ˆå……å?¼ä¸åˆ†åŒºæœï¼Œ
        // å……åˆ°ç»Ÿä¸€çš„ç”¨æˆ·è´¦æˆ·ï¼Œå„åŒºæœè§’è‰²å‡å¯ä½¿ç”¨ï¼‰ã€?
        bundle.putString(ProtocolKeys.APP_USER_NAME, pay.getAppUserName());

        // å¿…éœ€å‚æ•°ï¼Œåº”ç”¨å†…çš„ç”¨æˆ·idã€?
        // è‹¥åº”ç”¨å†…ç»‘å®š360è´¦å·å’Œåº”ç”¨è´¦å·ï¼Œå……å?¼ä¸åˆ†åŒºæœï¼Œå……åˆ°ç»Ÿä¸€çš„ç”¨æˆ·è´¦æˆ·ï¼Œå„åŒºæœè§’è‰²å‡å¯ä½¿ç”¨ï¼Œåˆ™å¯ç”?360ç”¨æˆ·IDæœ?å¤?32å­—ç¬¦ã€?
        bundle.putString(ProtocolKeys.APP_USER_ID, pay.getAppUserId());

        // å¯é?‰å‚æ•°ï¼Œåº”ç”¨æ‰©å±•ä¿¡æ¯1ï¼ŒåŸæ ·è¿”å›ï¼Œæœ?å¤?255å­—ç¬¦ã€?
        bundle.putString(ProtocolKeys.APP_EXT_1, pay.getAppExt1());

        // å¯é?‰å‚æ•°ï¼Œåº”ç”¨æ‰©å±•ä¿¡æ¯2ï¼ŒåŸæ ·è¿”å›ï¼Œæœ?å¤?255å­—ç¬¦ã€?
        bundle.putString(ProtocolKeys.APP_EXT_2, pay.getAppExt2());

        // å¿…é?‰å‚æ•°ï¼Œåº”ç”¨è®¢å•å·ï¼Œåº”ç”¨å†…å¿…é¡»å”¯ä¸?ï¼Œæœ€å¤?32å­—ç¬¦ã€?
        bundle.putString(ProtocolKeys.APP_ORDER_ID, pay.getAppOrderId());

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }

    /**
     * é’©å­æ–¹æ³•ï¼Œç•™ç»™ä½¿ç”¨æ”¯ä»˜çš„å­ç±»å®ç°getQihooPayInfo
     *
     * @param isFixed
     * @return
     */
    protected QihooPayInfo getQihooPayInfo(boolean isFixed) {
        return null;
    }

    /***
     * ç”Ÿæˆè°ƒç”¨360SDKé€?å‡ºæ¥å£çš„Intent
     *
     * @param isLandScape
     * @return Intent
     */
    private Intent getQuitIntent(boolean isLandScape) {

        Bundle bundle = new Bundle();

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç•Œé¢æ˜¯å¦ä»¥æ¨ªå±æ˜¾ç¤ºã??
        bundle.putBoolean(ProtocolKeys.IS_SCREEN_ORIENTATION_LANDSCAPE, isLandScape);

        // å¿…éœ€å‚æ•°ï¼Œä½¿ç”?360SDKçš„é??å‡ºæ¨¡å—ã??
        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_QUIT);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }

    /***
     * ç”Ÿæˆå®åæ³¨å†Œç™»å½•æ¥å£çš„Intent
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±
     * @param isBgTransparent æ˜¯å¦èƒŒæ™¯é€æ˜
     * @param qihooUserId å¥‡è™UserId
     * @return Intent
     */
    private Intent getRealNameRegisterIntent(boolean isLandScape, boolean isBgTransparent,
            String qihooUserId) {

        Bundle bundle = new Bundle();

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç•Œé¢æ˜¯å¦ä»¥æ¨ªå±æ˜¾ç¤ºã??
        bundle.putBoolean(ProtocolKeys.IS_SCREEN_ORIENTATION_LANDSCAPE, isLandScape);

        // èƒŒæ™¯æ˜¯å¦é€æ˜
        bundle.putBoolean(ProtocolKeys.IS_LOGIN_BG_TRANSPARENT, isBgTransparent);

        // å¿…éœ€å‚æ•°ï¼?360è´¦å·idï¼Œæ•´æ•°ã??
        bundle.putString(ProtocolKeys.QIHOO_USER_ID, qihooUserId);

        // å¿…éœ€å‚æ•°ï¼Œä½¿ç”?360SDKçš„å®åæ³¨å†Œæ¨¡å—ã??
        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_REAL_NAME_REGISTER);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }

    /***
     * ç”Ÿæˆç»‘å®šæ‰‹æœºå·æ¥å£çš„Intent
     *
     * @param isLandScape æ˜¯å¦æ¨ªå±
     * @param isBgTransparent æ˜¯å¦èƒŒæ™¯é€æ˜
     * @return Intent
     */
    private Intent getBindPhoneNumIntent(boolean isLandScape) {

        Bundle bundle = new Bundle();

        bundle.putBoolean(ProtocolKeys.IS_SCREEN_ORIENTATION_LANDSCAPE, isLandScape);

        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_BIND_PHONE_NUM);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }


    /**
     * ç”Ÿæˆæˆªå±å‘å¸–çš„Intent
     *
     * @param isLandScape
     * @return
     */
    private Intent getBBSPostIntent(boolean isLandScape) {

        Bundle bundle = new Bundle();

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç•Œé¢æ˜¯å¦ä»¥æ¨ªå±æ˜¾ç¤ºã??
        bundle.putBoolean(ProtocolKeys.IS_SCREEN_ORIENTATION_LANDSCAPE, isLandScape);

        // æ­¤å¤„å¯ä»¥ä¼ å…¥æ‚¨çš„æˆªå±è·¯å¾„
        bundle.putString(ProtocolKeys.BBS_POST_EXTRA_SNAP_PATH,
                Environment.getExternalStorageDirectory() + "/DCIM/screenshot/20130621152522.png");

        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_BBS_POSTS);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }

    // ---------------------------------360SDKæ¥å£çš„å›è°?-----------------------------------

    // ç™»å½•ã€æ³¨å†Œçš„å›è°ƒ
    private IDispatcherCallback mLoginCallback = new IDispatcherCallback() {

        @Override
        public void onFinished(String data) {
            Log.d(TAG, "mLoginCallback, data is " + data);
            String authorizationCode = parseAuthorizationCode(data);
            onGotAuthorizationCode(authorizationCode);
        }
    };

    // åˆ‡æ¢è´¦å·çš„å›è°?
    private IDispatcherCallback mAccountSwitchCallback = new IDispatcherCallback() {

        @Override
        public void onFinished(String data) {
            Log.d(TAG, "mAccountSwitchCallback, data is " + data);
            String authorizationCode = parseAuthorizationCode(data);
            onGotAuthorizationCode(authorizationCode);
        }
    };

    /**
     * ä»Jsonå­—ç¬¦ä¸­è·å–æˆæƒç 
     *
     * @param data Jsonå­—ç¬¦ä¸?
     * @return æˆæƒç ?
     */
    private String parseAuthorizationCode(String data) {
        String authorizationCode = null;
        if (!TextUtils.isEmpty(data)) {
            boolean isCallbackParseOk = false;
            try {
                JSONObject json = new JSONObject(data);
                int errCode = json.getInt("errno");
                if (errCode == 0) {
                    // åªæ”¯æŒcodeç™»é™†æ¨¡å¼
                    JSONObject content = json.getJSONObject("data");
                    if (content != null) {
                        // 360SDKç™»å½•è¿”å›çš„Authorization Codeï¼ˆæˆæƒç ï¼?60ç§’æœ‰æ•ˆï¼‰ã€?
                        authorizationCode = content.getString("code");
                        isCallbackParseOk = true;
                    }
                }
            } catch (JSONException e) {
                e.printStackTrace();
            }

            // ç”¨äºæµ‹è¯•æ•°æ®æ ¼å¼æ˜¯å¦å¼‚å¸¸ã€?
            if (!isCallbackParseOk) {
                Toast.makeText(SdkUserBaseActivity.this, getString(R.string.data_format_error),
                        Toast.LENGTH_LONG).show();
            }
        }
        Log.d(TAG, "parseAuthorizationCode=" + authorizationCode);
        return authorizationCode;
    }

    // æ”¯ä»˜çš„å›è°?
    protected IDispatcherCallback mPayCallback = new IDispatcherCallback() {

        @Override
        public void onFinished(String data) {
            Log.d(TAG, "mPayCallback, data is " + data);
            boolean isCallbackParseOk = false;
            JSONObject jsonRes;
            try {
                jsonRes = new JSONObject(data);
                // error_code çŠ¶æ?ç ï¼? 0 æ”¯ä»˜æˆåŠŸï¼? -1 æ”¯ä»˜å–æ¶ˆï¼? 1 æ”¯ä»˜å¤±è´¥ï¼? -2 æ”¯ä»˜è¿›è¡Œä¸­ã??
                // error_msg çŠ¶æ?æè¿?
                int errorCode = jsonRes.getInt("error_code");
                switch (errorCode) {
                    case 0:
                    case 1:
                    case -1:
                    case -2: {
                        String errorMsg = jsonRes.getString("error_msg");
                        String text = getString(R.string.pay_callback_toast, errorCode, errorMsg);
                        Toast.makeText(SdkUserBaseActivity.this, text, Toast.LENGTH_SHORT).show();
                        isCallbackParseOk = true;
                    }
                        break;
                    default:
                        break;
                }
            } catch (JSONException e) {
                e.printStackTrace();
            }

            // ç”¨äºæµ‹è¯•æ•°æ®æ ¼å¼æ˜¯å¦å¼‚å¸¸ã€?
            if (!isCallbackParseOk) {
                Toast.makeText(SdkUserBaseActivity.this, getString(R.string.data_format_error),
                        Toast.LENGTH_LONG).show();
            }
        }
    };

    // å®åæ³¨å†Œçš„å›è°?
    private IDispatcherCallback mRealNameRegisterCallback = new IDispatcherCallback() {

        @Override
        public void onFinished(String data) {
            Log.d(TAG, "mRealNameRegisterCallback, data is " + data);
        }
    };

    // ----------------------------------------------------------------

    private Handler mHandler = new Handler();

    private boolean mShouldGameKillProcessExit = false;

    // é€?å‡ºçš„å›è°ƒ
    private IDispatcherCallback mQuitCallback = new IDispatcherCallback() {

        @Override
        public void onFinished(String data) {
            Log.d(TAG, "mQuitCallback, data is " + data);
            JSONObject json;
            try {
                json = new JSONObject(data);
                int which = json.optInt("which", -1);
                String label = json.optString("label");

                Toast.makeText(SdkUserBaseActivity.this,
                        "æŒ‰é’®æ ‡è¯†ï¼?" + which + "ï¼ŒæŒ‰é’®æè¿?:" + label, Toast.LENGTH_LONG)
                        .show();

                switch (which) {
                    case 0: // ç”¨æˆ·å…³é—­é€?å‡ºç•Œé?
                        return;
                    default:// é€?å‡ºæ¸¸æˆ?
                        // æ³¨æ„ï¼šæ­¤å¤„ä»£ç æ¨¡æ‹Ÿæ¸¸æˆfinishå¹¶æ€è¿›ç¨‹é€?å‡ºçš„åœºæ™¯ï¼Œå¯¹äºä¸æ?è¿›ç¨‹é€?å‡ºçš„æ¸¸æˆï¼Œç›´æ¥finishå³å¯ã€?
                        doGameKillProcessExit();
                        return;
                }
            } catch (JSONException e) {
                e.printStackTrace();
            }
        }

        // æ³¨æ„ï¼šmQuitCallbackä¸­ä»¥ä¸‹ä»£ç ï¼Œç”¨äºæ¨¡æ‹Ÿæ¸¸æˆfinishå¹¶æ€è¿›ç¨‹é€?å‡ºçš„åœºæ™¯ï¼Œå¯¹äºä¸æ?è¿›ç¨‹é€?å‡ºçš„æ¸¸æˆï¼Œè¯·å¿½ç•¥ã€?

        private boolean mHaveShowedChooser = false;

        private int mTestIfTopChooserCount = 0;

        private Runnable mTestIfTopChooser = new Runnable() {

            @Override
            public void run() {

                if (canDoGameKillProcessExit()) {
                    doGameKillProcessExit();
                } else {
                    mHandler.postDelayed(mTestIfTopChooser, 200);
                }

            }
        };

        private boolean canDoGameKillProcessExit() {

            String topPkgName = "";

            ActivityManager am = (ActivityManager) SdkUserBaseActivity.this
                    .getSystemService(Context.ACTIVITY_SERVICE);
            List<RunningTaskInfo> runningTasks = am.getRunningTasks(1);
            if (runningTasks != null) {
                RunningTaskInfo taskInfo = runningTasks.get(0);
                if (taskInfo != null) {
                    ComponentName component = taskInfo.topActivity;
                    if (component != null) {
                        topPkgName = component.getPackageName();
                    }
                }
            }

            Log.d(TAG, "topPkgName = " + topPkgName);

            boolean isCurrTopChooser = "android".equals(topPkgName);

            Log.d(TAG, "isCurrTopChooser = " + isCurrTopChooser);
            if (isCurrTopChooser) {
                mHaveShowedChooser = true;
            }

            // ä¸?ç›´ä¸æ˜¾ç¤ºChooserï¼Œè¯´æ˜æ²¡Chooserï¼Œå¯ä»¥ç›´æ¥é??å‡?
            if (mTestIfTopChooserCount > 2) {
                if (!mHaveShowedChooser) {
                    return true;
                }
            }
            mTestIfTopChooserCount++;
            Log.d(TAG, "mTestIfTopChooserCount = " + mTestIfTopChooserCount);

            // æ˜¾ç¤ºè¿‡Chooserï¼Œç°åœ¨ä¸æ˜¾ç¤ºäº†ï¼Œæ­¤æ—¶å¯ä»¥é€?å‡ºäº†
            Log.d(TAG, "mHasShowChooser = " + mHaveShowedChooser);
            if (mHaveShowedChooser && !isCurrTopChooser) {
                return true;
            }

            return false;
        }

        private void doGameKillProcessExit() {
            Log.d(TAG, "doGameKillProcessExit");
            finish();
            mShouldGameKillProcessExit = true;
        }

    };

    @Override
    protected void onDestroy() {
        super.onDestroy();

        if (mShouldGameKillProcessExit) {
            mHandler.post(new Runnable() {

                @Override
                public void run() {
                    android.os.Process.killProcess(android.os.Process.myPid());
                }
            });
        }
    };

    // ----------------------------------------------------------------

    private IDispatcherCallback mBindPhoneNumCallback = new IDispatcherCallback() {

        @Override
        public void onFinished(String data) {
            Log.d(TAG, "mBindPhoneNumCallback, data is " + data);
        }
    };

    // -----------------------------------------é˜²æ²‰è¿·æŸ¥è¯¢æ¥å?----------------------------------------

    /**
     * æœ¬æ–¹æ³•ä¸­çš„callbackå®ç°ä»…ç”¨äºæµ‹è¯?, å®é™…ä½¿ç”¨ç”±æ¸¸æˆå¼€å‘è?…è‡ªå·±å¤„ç?
     *
     * @param qihooUserId
     * @param accessToken
     */
    protected void doSdkAntiAddictionQuery(String qihooUserId, String accessToken) {
        Intent intent = getAntiAddictionIntent(qihooUserId, accessToken);
        Matrix.execute(this, intent, new IDispatcherCallback() {

            @Override
            public void onFinished(String data) {
                Log.d("demo,anti-addiction query result = ", data);
                if (!TextUtils.isEmpty(data)) {
                    try {
                        JSONObject resultJson = new JSONObject(data);
                        int errorCode = resultJson.getInt("error_code");
                        if (errorCode == 0) {
                            JSONObject contentData = resultJson.getJSONObject("content");
                            // ä¿å­˜ç™»å½•æˆåŠŸçš„ç”¨æˆ·ååŠå¯†ç ?
                            JSONArray retData = contentData.getJSONArray("ret");
                            Log.d(TAG, "ret data = " + retData);
                            int status = retData.getJSONObject(0).getInt("status");
                            Log.d(TAG, "status = " + status);
                            if (status == 0) {
                                Toast.makeText(SdkUserBaseActivity.this,
                                        getString(R.string.anti_addiction_query_result_0),
                                        Toast.LENGTH_LONG).show();
                            } else if (status == 1) {
                                Toast.makeText(SdkUserBaseActivity.this,
                                        getString(R.string.anti_addiction_query_result_1),
                                        Toast.LENGTH_LONG).show();
                            } else if (status == 2) {
                                Toast.makeText(SdkUserBaseActivity.this,
                                        getString(R.string.anti_addiction_query_result_2),
                                        Toast.LENGTH_LONG).show();
                            }
                        } else {
                            Toast.makeText(SdkUserBaseActivity.this,
                                    resultJson.getString("error_msg"), Toast.LENGTH_SHORT).show();
                        }

                    } catch (JSONException e) {
                        Toast.makeText(SdkUserBaseActivity.this,
                                getString(R.string.anti_addiction_query_exception),
                                Toast.LENGTH_LONG).show();
                        e.printStackTrace();

                    }
                }
            }
        });
    }

    /**
     * ç”Ÿæˆé˜²æ²‰è¿·æŸ¥è¯¢æ¥å£çš„Intentå‚æ•°
     *
     * @param qihooUserId
     * @param accessToken
     * @return Intent
     */
    private Intent getAntiAddictionIntent(String qihooUserId, String accessToken) {

        Bundle bundle = new Bundle();

        // å¿…éœ€å‚æ•°ï¼Œç”¨æˆ·access tokenï¼Œè¦ä½¿ç”¨æ³¨æ„è¿‡æœŸå’Œåˆ·æ–°é—®é¢˜ï¼Œæœ?å¤?64å­—ç¬¦ã€?
        bundle.putString(ProtocolKeys.ACCESS_TOKEN, accessToken);

        // å¿…éœ€å‚æ•°ï¼?360è´¦å·idï¼Œæ•´æ•°ã??
        bundle.putString(ProtocolKeys.QIHOO_USER_ID, qihooUserId);

        // å¿…éœ€å‚æ•°ï¼Œä½¿ç”?360SDKçš„é˜²æ²‰è¿·æŸ¥è¯¢æ¨¡å—ã€?
        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_ANTI_ADDICTION_QUERY);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }

    /***
     * ç”Ÿæˆè°ƒç”¨360SDKè®ºå›æ¥å£çš„Intent
     *
     * @param isLandScape
     * @return Intent
     */
    private Intent getBBSIntent(boolean isLandScape) {

        Bundle bundle = new Bundle();

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç•Œé¢æ˜¯å¦ä»¥æ¨ªå±æ˜¾ç¤ºã??
        bundle.putBoolean(ProtocolKeys.IS_SCREEN_ORIENTATION_LANDSCAPE, isLandScape);

        // å¿…éœ€å‚æ•°ï¼Œä½¿ç”?360SDKçš„è®ºå›æ¨¡å—ã??
        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_BBS);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }

    /***
     * ç”Ÿæˆè°ƒç”¨360SDKå®¢æœæ¥å£çš„Intent
     *
     * @param isLandScape
     * @return Intent
     */
    private Intent getCustomerServiceIntent(boolean isLandScape) {

        Bundle bundle = new Bundle();

        // ç•Œé¢ç›¸å…³å‚æ•°ï¼?360SDKç•Œé¢æ˜¯å¦ä»¥æ¨ªå±æ˜¾ç¤ºã??
        bundle.putBoolean(ProtocolKeys.IS_SCREEN_ORIENTATION_LANDSCAPE, isLandScape);

        // å¿…éœ€å‚æ•°ï¼Œä½¿ç”?360SDKçš„è®ºå›æ¨¡å—ã??
        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_CUSTOMER_SERVICE);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }

    // -----------------------------------------è‡ªæ£€æŸ¥è¯¢æ¥å£----------------------------------------

    /**
     * æœ¬æ–¹æ³•ä¸­çš„callbackå®ç°ä»…ç”¨äºæµ‹è¯?, å®é™…ä½¿ç”¨ç”±æ¸¸æˆå¼€å‘è?…è‡ªå·±å¤„ç?
     */
    protected void doSdkSelfCheck() {
        Intent intent = getSelfCheckIntent();
        Matrix.execute(this, intent, new IDispatcherCallback() {

            @Override
            public void onFinished(String data) {
                Log.d("demo, self check result = ", data);
                try {
                    JSONObject result = new JSONObject(data);
                    Toast.makeText(SdkUserBaseActivity.this, result.optString("error_msg"),
                            Toast.LENGTH_LONG).show();

                } catch (JSONException e) {
                    e.printStackTrace();
                }
            }
        });
    }

    /**
     * ç”Ÿæˆ360SDKè‡ªæ£€çš„Intentå‚æ•°
     *
     * @return Intent
     */
    private Intent getSelfCheckIntent() {

        Bundle bundle = new Bundle();

        // å¿…éœ€å‚æ•°ï¼Œä½¿ç”?360SDKçš„è‡ªæ£?æ¨¡å—
        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_SELF_CHECK);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }

    // -----------------------------------------proåŒ…ä¿¡æ¯æŸ¥è¯¢æ¥å?----------------------------------------

    /**
     * æœ¬æ–¹æ³•ä¸­çš„callbackå®ç°ä»…ç”¨äºæµ‹è¯?, å®é™…ä½¿ç”¨ç”±æ¸¸æˆå¼€å‘è?…è‡ªå·±å¤„ç?
     */
    protected void doSdkProInfoQuery() {
        Intent intent = getProInfoQueryIntent();
        Matrix.execute(this, intent, new IDispatcherCallback() {

            @Override
            public void onFinished(String data) {
                Log.d("demo, self check result = ", data);
                try {
                    JSONObject result = new JSONObject(data);
                    int errCode = result.optInt("error_code");
                    if (errCode == 0) {
                        JSONObject content = result.optJSONObject("content");
                        String verName = null;
                        int verCode = 0;
                        if (content != null) {
                            verName = content.optString("ver_name");
                            verCode = content.optInt("ver_code");
                        }
                        Toast.makeText(SdkUserBaseActivity.this,
                                "version name: " + verName + ", version code: " + verCode,
                                Toast.LENGTH_LONG).show();
                    } else {
                        Toast.makeText(SdkUserBaseActivity.this, result.optString("error_msg"),
                                Toast.LENGTH_LONG).show();
                    }

                } catch (JSONException e) {
                    e.printStackTrace();
                }
            }
        });
    }

    /**
     * ç”ŸæˆSDKæŸ¥è¯¢çš„Intentå‚æ•°
     *
     * @return Intent
     */
    private Intent getProInfoQueryIntent() {

        Bundle bundle = new Bundle();

        // å¿…éœ€å‚æ•°ï¼Œä½¿ç”?360SDKçš„proåŒ…æŸ¥è¯¢æ¨¡å?
        bundle.putInt(ProtocolKeys.FUNCTION_CODE, ProtocolConfigs.FUNC_CODE_OUT_SDK_INFO);

        Intent intent = new Intent(this, ContainerActivity.class);
        intent.putExtras(bundle);

        return intent;
    }
}